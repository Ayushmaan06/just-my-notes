# Введение в процессы загрузки ядра и запуска системы Linux

Есть два ряда событий, необходимых для приведения компьютера с Linux в рабочее состояние: 

- загрузка ядра (boot) 
- запуск системы (startup)

Процесс загрузки ядра начинается при включении компьютера и заканчивается с инициализацией ядра и запуском systemd. После этого начинается процесс запуска системы, и именно он доводит компьютер Linux до рабочего состояния. 

Процесс загрузки ядра и запуск системы Linux состоит из следующих шагов:

1. BIOS POST. Первый шаг процесса загрузки ядра Linux не имеет никакого отношения к Linux. Это аппаратная часть процесса, одинаковая для всех операционных систем. Когда питание подается на компьютер, в первую очередь происходит запуск POST (Power On Self Test), являющегося частью BIOS (Basic I/O System, Базовая Система Ввода-Вывода). Задачей POST является обеспечение корректной работы компьютерного оборудования. Если POST заканчивается неудачно, то возможно компьютер неисправен, и процесс загрузки не продолжается. 

> Подробнее. BIOS POST проверяет базовую работоспособность железа, а затем вызывает прерывание BIOS — INT 13H, которое находит секторы загрузки ядра на всех подключенных устройствах с возможностью загрузки (загрузочные записи на прикрепленных дисках обычно распологаются в Главной Загрузочной Записи (Master Boot Record, MBR)). Первый найденный сектор, в котором содержится валидная загрузочная запись, загружается в RAM, после чего контроль передается коду из загрузочного сектора (bootstrap код - следующий пункт).

2. Загрузка ядра (GRUB2). GRUB2 расшифровывается как "GRand Unified Bootloader, version 2", и теперь он является основным загрузчиком для большинства современных дистрибутивов Linux. GRUB2 — программа, которая делает компьютер достаточно "умным", чтобы тот смог найти ядро операционной системы, загрузить его в память RAM и запустить его. Этапы работы GRUB:
  
  - целью этапа 1 является обнаружение и загрузка следующего этапа (благодаря bootstrap коду).
  - задача этапа 1.5 — начать с необходимыми драйверами файловой системы поиск файлов этапа 2 в файловой системе /boot и загрузить нужные драйверы.
  - задача этапа 2 GRUB2 — обнаружить и загрузить ядро Linux в RAM и передать контроль управления компьютером ядру. Ядро и связанные с ним файлы находятся в директории /boot. Файлы ядра легко узнать, поскольку их названия начинаются с vmlinuz.

  > TODO: Понять этот пункт и по возможности дополнить.

3. Инициализация ядра. Все ядра находятся в самораспаковывающемся, сжатом формате для экономии места. Ядра расположены в директории /boot, вместе с исходным образом диска RAM и списком разделов на жестких дисках. После того, как выбранное ядро загружено в память и начинает исполняться, в первую очередь, оно должно извлечь самого себя из сжатой версии файла, перед тем как начать выполнять полезную работу. Как только извлечение произошло, оно загружает systemd, который является заменой старой программе SysV init, и передает ему контроль. Это конец процесса загрузки ядра. К этому моменту, ядро Linux и systemd запущены, но не могут выполнять какие-либо полезные задачи для конечного пользователя, так как выполнять еще нечего. Процесс запуска системы следует за процессом загрузки ядра и приводит компьютер с Linux в рабочее состояние.

> Ошибка в тексте: "оно загружает systemd, который является заменой старой программе SysV init, и передает ему контроль". Ядро не передаёт никому контроль, ядро запускает первый процесс, который уже управляет запуском других процессов.

> Чего? : "К этому моменту, ядро Linux и systemd запущены, но не могут выполнять какие-либо полезные задачи для конечного пользователя, так как выполнять еще нечего".


4. Запуск systemd. systemd — родитель всех процессов, ответственный за приведение хоста Linux в состояние эффективной работы. Что он делает:
  - cначала, systemd монтирует файловые системы, как определено в /etc/fstab, включая любые swap-файлы и разделы. К этому моменту, он может получить доступ к файлам конфигурации, расположенным в /etc, включая его собственным. Он использует собственный конфигурационный файл /etc/systemd/system/default.target, чтобы определить таргет (target), по которому нужно загрузить хост. Файл default.target — просто симлинк на настоящий target файл. Для настольной рабочей станции обычно это graphical.target, эквивалентный runlevel 5 в старом инициализаторе SystemV. Для сервера, по умолчанию скорее всего будет multi-user.target, аналогичный runlevel 3 в SystemV. emergency.target похож на однопользовательский режим. У каждого таргета есть набор зависимостей, описанных в файле конфигурации. systemd запускает необходимые. Эти зависимости представляют собой сервисы, требуемые для запуска хоста Linux с определенным уровнем функционирования. Когда все зависимости, перечисленные в конфигурационных файлах таргета, загружены и запущены, система работает на этом уровне таргета.

  - systemd также просматривает устаревшие директории инициализации SystemV на предмет наличия стартап файлов. Если они есть, systemd использует их в качестве файлов конфигурации для запуска сервисов описанных в файлах. Устаревший сетевой сервис — хороший пример одного из тех, что до сих пор используют стартап файлы SystemV в Fedora.

  -  sysinit.target достигается, когда завершены все юниты, от которых он зависит. Должны быть завершены все следующие юниты: монтирование файловых систем, настройка swap-файлов, запуск udev, настройка начального состояния генератора случайных чисел, инициализация низкоуровневых сервисов, настройка криптографических сервисов, если хотя бы одна файловая система зашифрована. В sysinit.target они могут выполняться параллельно. sysinit.target запускает все низкоуровневые сервисы и юниты необходимые для минимальной функциональности системы, и те, что нужны для перехода к basic.target.

  - После выполнения sysinit.target, systemd запускает basic.target, начиная со всех юнитов, необходимых для его выполнения. Базовый таргет предоставляет дополнительный функционал, запуская юниты необходимые для следующего таргета, включая настройку путей до различных исполняемых директорий, коммуникационных сокетов и таймеров.
  
  - Наконец, можно начать инициализацию таргетов пользовательского уровня: multi-user.target или graphical.target. Стоит отметить, что multi-user.target должен быть достигнут до того, как будут выполнены зависимости графического таргета.

  - Запуск системы завершается по достижении одного из таких таргетов: graphical.target, multi-user.target, emergency.target, rescue-target. Если multi-user.target является таргетом по умолчанию, то в консоли вы увидите логин в текстовом режиме. Если же по умолчанию задан graphical.target, то увидите графический логин; GUI экрана логина зависит от экранного менеджера, который вы используете.

  > TODO: понять раздел и разобраться с systemd.

  ## Выводы

GRUB2 и система инициализации systemd — ключевые компоненты для фаз загрузки ядра и запуска системы большинства современных дистрибутивов Linux. Несмотря на противоречия, особенно вокруг systemd, эти два компонента хорошо работают вместе для загрузки ядра и запуска всех системных сервисов, необходимых для создания функциональной системы Linux.

  ## Комментарии с Хабра

> MBR сейчас отходит в мир иной. Я сейчас как-то предпочитаю выбор операционки для загрузки оставлять на откуп EFI. Плюс на EFI все таки grub+systemd грузится чуть медленней чем EFIstub+systemd.

> Efistub к сожалению не даст гибкости, которую дает полноценный загрузчик. Не прописывать же все варианты загрузки в nvram. С другой стороны, grub — сложный монстр. Есть отличный загрузчик refind, который из себя представляет бинарь + опционально драйверы ФС + конфиги от пустых до любой сложности. Его невозможно сломать, в отличие от grub.

